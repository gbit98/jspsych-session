<!DOCTYPE html>
<html>
  <head>
    <title>Official Experiment</title>
    <style>
  #jspsych-content {
    display: block !important;
    margin-top: 80px; /* adjust as needed */
    transform: none !important;
    top: auto !important;
    position: static !important;
  }
    </style>
    <script src="https://unpkg.com/jspsych@8.2.1"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-preload@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.1.0"></script>
    <link href="https://unpkg.com/jspsych@8.2.1/css/jspsych.css" rel="stylesheet" type="text/css" />
  </head>

  <body></body>
  
  <script>
    const jsPsych = initJsPsych();
    const timeline = [];
    const preload = {
      type: jsPsychPreload,
      images: ['Diagram1.png', 'Diagram2.png']
    };
    timeline.push(preload);

//Define Groups
const groups = ['TD/N', 'N/TD'];
const assignedGroup = jsPsych.randomization.sampleWithoutReplacement(groups, 1)[0];
console.log("Assigned group:", assignedGroup);


// Store group in data
jsPsych.data.addProperties({ group: assignedGroup });

var min_time = 5000;

const wait_trial = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus: "Read this carefully.",
  choices: "NO_KEYS",
  trial_duration: min_time
};

const response_trial = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus: "Read this carefully.",
  choices: [" "], // or whatever key(s) you want to allow
  prompt: "<p>Press SPACE to continue.</p>"
};

//Welcome Page
const welcome_page = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `
    <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; text-align: center; font-size: 20px; line-height: 1.8; padding: 0 40px;">
      <div style="max-width: 800px;">
        <p>Welcome to this pilot testing session! Thank you for participating.</p>
        
        <p style="margin-top: 60px;"><em>Press any key to continue.</em></p>
      </div>
    </div>
  `,
  };


//Word Presentation Info Page #1
const word_presentation_info_page1 = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `
    <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; text-align: left; font-size: 18px; line-height: 1.8; padding: 0 40px;">
      <div style="max-width: 800px;">

        <p>In the upcoming task, you will see 15 words, shown one at a time, on your screen.</p>

        <p>Please read each word carefully and try to remember as many as you can. Each word will appear for 6.5 seconds before moving to the next one.</p>

        <p>Once all 15 words have been shown, you will complete a brief image comparison task, before being taken to a new screen where you will type in as many of the words as you can remember.</p>

        <p><strong>Important:</strong> Please do not write the words down or take screenshots. This is a test of memory, and using notes would affect the results. We appreciate your honesty and cooperation.</p>

        <p>You can list the words in any order. If you can’t remember all the words, don’t worry — just give your best guess.</p>

        <p style="margin-top: 40px;"><em>Press any key to begin the task.</em></p>

      </div>
    </div>
  `
};


const all_nouns = [
  "Square", "Fabric", "Angle", "Gold", "Insect", "Wife", "Child", "Ship", "Lake", 
  "Mast", "House", "Butter", "Meadow", "Scarlet", "Twilight" 
];

// Randomly select 15 nouns
const selected_nouns = jsPsych.randomization.sampleWithoutReplacement(all_nouns, 15);

jsPsych.data.addProperties({ presented_words: selected_nouns });

// Start with a red dot for 1.5s
const red_dot_start = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus:`
  <div style="display: flex; justify-content: center; align-items: center; height: 100vh;">
    <div style="font-size: 48px; color: red;">•</div>
  </div>
`,
  choices: "NO_KEYS",
  trial_duration: 1500
};

// Create trials: alternating words and red dots
const word_trials = [];

selected_nouns.forEach((word, index) => {
  // Show the word
  word_trials.push({
    type: jsPsychHtmlKeyboardResponse,
    stimulus: `
  <div style="display: flex; justify-content: center; align-items: center; height: 100vh;">
    <div style="font-size: 32px; color: black;">${word}</div>
  </div>
`
,
    choices: "NO_KEYS",
    trial_duration: 6500
  });

  // Show a 1/2-second red dot between words (except after the last word)
  if (index < selected_nouns.length - 1) {
    word_trials.push({
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
  <div style="display: flex; justify-content: center; align-items: center; height: 100vh;">
    <div style="font-size: 48px; color: red;">•</div>
  </div>
`,
      choices: "NO_KEYS",
      trial_duration: 500
    });
  }
});

// Push full structure to the timeline

// Baseline Noun Recall
const nouns_recall_pre = {
  type: jsPsychSurveyHtmlForm,
  preamble: `
    <div style="max-width: 800px; margin: auto; font-size: 18px; line-height: 1.8; text-align: left;">
      <p><strong>Recall Task</strong></p>
      <p>Please type in as many of the 15 words you just saw as you can remember. You can list them in any order.</p>
      <p>For any items you can't remember, simply type <em>N/a</em> into the corresponding box/s.</p>
    </div>
  `,
  html: `
    ${[...Array(15)].map((_, i) =>
      `<p>${i + 1}. <input name="recall${i + 1}" type="text" style="width: 400px;" required></p>`
    ).join("")}
  `,
  button_label: "Submit",

  // Record number of correct responses
on_finish: function(data) {
  const nouns_pre_recall_responses = Object.values(data.response).map(r => r.trim().toLowerCase());
  const presented = jsPsych.data.get().values()[0].presented_words.map(w => w.toLowerCase());

  const num_correct = nouns_pre_recall_responses.filter(r => presented.includes(r)).length;

  jsPsych.data.addProperties({ nouns_pre_correct: num_correct });
}

};


//Well Done Page
const well_done_page = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `
    <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; text-align: center;">
      <div style="font-size: 24px;">
        <p><strong>Well done!</strong></p>
        <p style="margin-top: 40px;"><em>Press any key to continue to the next task.</em></p>
      </div>
    </div>
  `
};


//ToDo Presentation Info Page
const ToDo_presentation_info_page1 = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `
    <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; text-align: left; font-size: 18px; line-height: 1.8; padding: 0 40px;">
      <div style="max-width: 800px;">

        <p>In the upcoming task, you will see 15 phrases, shown one at a time on your screen, describing a brief everyday task.</p>
         
        <p>Please read each item carefully and try to remember as many as you can. Each item will appear for 10 seconds before moving to the next one.</p>

        <p>Once all items have been shown, you will complete a brief image comparison task, before being taken to a new screen where you will type in as many of the items as you can remember.</p>

        <p><strong>Important:</strong> Please do not write the items down or take screenshots. This is a test of memory, and using notes would affect the results. We appreciate your honesty and cooperation.</p>

        <p>You can list the items in any order. If you can’t remember all the items, don’t worry — just give your best guess.</p>

        <p style="margin-top: 40px;"><em>Press any key to begin the task.</em></p>

      </div>
    </div>
  `
};


const all_tasks = [
  "Organise recycling", "Check fridge", "Reset password",
  "Replace batteries", "Stamp letters", "Clean sunglasses",
  "Remove receipts", "Empty bag", "Pump football",
  "Fill kettle", "Schedule appointment", "Sort plates",
  "Unpack dishwasher", "Create playlist", "Switch off alarm",
  "Fold clothes", "Charge phone", "Clean mirror",
  "Write list", "Check mailbox", "Refill bottle",
  "Feed pet", "Sort laundry", "Water plants",
  "Replace bulb", "Backup files", "Wipe bench",
  "Tie laces", "Take vitamins", "Open curtains",
  "Test alarm", "Pack lunch", "Unplug toaster",
  "Organise drawer", "Dust shelf", "Sharpen pencil",
  "Lock door", "Update calendar", "Delete emails"
];


const task_phase1_items = jsPsych.randomization.sampleWithoutReplacement(all_tasks, 15);

// Remove selected tasks from the pool
const remaining_tasks = all_tasks.filter(task => !task_phase1_items.includes(task));

// Select new non-overlapping tasks for second round
const task_phase2_items = jsPsych.randomization.sampleWithoutReplacement(remaining_tasks, 15);


function generateTaskTrials(taskArray, trialTag) {
  const trials = [];

  taskArray.forEach((task, index) => {
    trials.push({
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <div style="display: flex; justify-content: center; align-items: center; height: 100vh;">
          <div style="font-size: 32px; color: black;">${task}</div>
        </div>
      `,
      choices: "NO_KEYS",
      trial_duration: 10000
    });

    if (index < taskArray.length - 1) {
      trials.push({
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
          <div style="display: flex; justify-content: center; align-items: center; height: 100vh;">
            <div style="font-size: 48px; color: red;">•</div>
          </div>
        `,
        choices: "NO_KEYS",
        trial_duration: 500
      });
    }
  });

  // Save the task list to data
  jsPsych.data.addProperties({ [`${trialTag}_tasks`]: taskArray });

  return trials;
}

function generateRecallPage(originalTasks, tag) {
  return {
    type: jsPsychSurveyHtmlForm,
    preamble: `
      <div style="max-width: 800px; margin: auto; font-size: 18px;">
        <p>Please type in as many of the 15 tasks you just saw as you can remember. You can list them in any order.</p>
        <p>For any tasks you can't remember, simply type N/a into the corresponding box/s.</p>
      </div>
    `,
    html: Array.from({ length: 15 }, (_, i) =>
      `<p> ${i + 1}: <input name="recall${i + 1}" type="text" style="width: 300px;" required></p>`
    ).join(''),
    button_label: "Submit",
    on_finish: function(data) {
      const responses = data.response;
      const correctTasks = originalTasks.map(w => w.toLowerCase());
      let correctCount = 0;
      const incorrect = [];

      Object.values(responses).forEach(resp => {
        const cleaned = resp.trim().toLowerCase();
        if (cleaned !== 'n/a' && correctTasks.includes(cleaned)) {
          correctCount++;
        } else {
          incorrect.push(cleaned);
        }
      });
      let tasksRecallKey = '';
        if (tag === 'phase1') tasksRecallKey = 'tasks_pre_correct';
        else if (tag === 'phase2') tasksRecallKey = 'tasks_post_correct';
      
        jsPsych.data.addProperties({
        [tasksRecallKey]: correctCount,
      });
    }
  };
}



//MoL Intervention
let currentPageIndex = 0;

const instructionsLooping = {
  timeline: [{
    type: jsPsychHtmlKeyboardResponse,
    stimulus: function() {
      return instructionPages[currentPageIndex].stimulus;
    },
    choices: ['ArrowLeft', 'ArrowRight'],
    on_finish: function(data) {
      if (data.response === 'ArrowLeft' && currentPageIndex > 0) {
        currentPageIndex--;
      } else if (data.response === 'ArrowRight') {
  currentPageIndex++;
  }

    }
  }],
  loop_function: function() {
    return currentPageIndex < instructionPages.length;
  },
  on_finish: function(data) {
  if (data.response === 'ArrowLeft' && currentPageIndex > 0) {
    currentPageIndex--;
  } else if (data.response === 'ArrowRight') {
    currentPageIndex++;
  }
}

};


//Define your instructional pages
const instructionPages = [


    // Post-Baseline Test Screen
 {
stimulus: `
<div style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; text-align: center;">
    <div style="max-width: 800px; font-size: 18px; line-height: 1.6;">   

<p><strong>Well done!</strong></p>
    
    <p>In the next phase of the task, you will be taught how to use a memory strategy known as <strong>"the Method of Loci"</strong>.</p>
    
    <div style="text-align: center; margin-top: 100px;">
          <em>Press → to continue.</em>
        </div>
        </div>
    `
      },
  
  // Instruction Page 1
  {
stimulus: `
    <div style="text-align: left; font-size: 18px; line-height: 1.6; max-width: 800px; margin: auto;">
      
         <div style="text-align: center; color: #3b80a9; font-size: 36px; font-weight: 600; margin-bottom: 20px;">
        <strong>The Method of Loci:</strong>
      </div>
      
      <div style="color: #3b80a9; font-size: 22px; font-weight: 600; margin-bottom: 12px;">
      <strong>What is it?</strong>
      </div>

      
      <p>
        The Method of Loci is a powerful memory technique that uses 
        <strong>vivid, visuo-spatial mental imagery</strong> to strengthen learning and recall. 
        It works by pairing new information with 
        <strong>well-known physical environments</strong> and the 
        <strong>distinctive objects within them</strong>.
      </p>

      <div style="text-align: center; margin-top: 30px;">
        <img src='Diagram1.png'style="width: 75%; display: block; margin: auto;"></img> 
      </div>
      
       <div style="text-align: center; margin-top: 100px;">
        <em>Press → to continue or ← to go back.</em>
      </div>
    </div>
  `
  
},


// Instruction Page 2
{
stimulus: `
<div style="text-align: left; font-size: 18px; line-height: 1.6; max-width: 800px; margin: auto;">
      
  <div style="color: #3b80a9; font-size: 22px; font-weight: 600; margin-bottom: 12px;">
      <strong>How Does it Work?</strong>
      </div>

      <p>
        The technique involves mentally selecting a 
        <strong>familiar physical setting</strong>—such as your home, workplace, university, or a 
        frequently travelled route — and identifying distinctive, memorable landmarks or objects within 
        that setting. These are known as your <strong>“loci”</strong> (singular: “locus”).
      </p>

      <p>
        You then imagine yourself moving through this environment in a fixed, logical sequence, 
        paying attention to each locus in <strong>order</strong>—just like following a set path or tour.
      </p>

      <p>
        At each stop along your imagined route, you create a mental image that links a piece of new 
        information to that specific location or object. These images work best when they 
        are <strong>exaggerated, unusual, or even bizarre</strong>, making them more memorable than 
        ordinary or realistic images.
      </p>

      <p style="text-align: center; margin-top: 100px;">
        <em>Press → to continue or ← to go back.</em></p>
    </div>
`
},

// Instruction Page 3
{
stimulus: `
    <div style="max-width: 800px; margin: auto; font-size: 18px; line-height: 1.8; text-align: left;">
      
      <div style="color: #3b80a9; font-size: 22px; font-weight: 600; margin-bottom: 12px;">
      <strong>Key Tips for Using it Effectively</strong>
      </div>

      <ol>
        <li><strong>Choose a highly familiar environment</strong> you can easily visualise.</li>

        <li><strong>Plan a clear, logical route</strong> through that environment, moving from one location to the next in sequence.</li>

        <li><strong>Identify several distinctive objects or landmarks</strong> along the way—these will be your loci.</li>

        <li><strong>Create vivid mental images that link new information to each locus</strong>, imagining these connections as you move through your route in order.</li>

        <li><strong>Make your images exaggerated, strange, or surprising</strong>, as unusual associations are typically much more memorable than ordinary ones.</li>
      </ol>

      <div style="text-align: center; margin-top: 100px;">
        <em>Press → to continue or ← to go back.</em>
      </div>
    </div>
  `
},

{
stimulus: `
    <div style="max-width: 800px; margin: auto; font-size: 18px; line-height: 1.8; text-align: left;">
      
      <div style="color: #3b80a9; font-size: 22px; font-weight: 600; margin-bottom: 12px;">
      <strong>Key Tips for Using it Effectively</strong>
      </div>

      <ol>
        <li><strong>Choose a highly familiar environment</strong> you can easily visualise.</li>

        <li><strong>Plan a clear, logical route</strong> through that environment, moving from one location to the next in sequence.</li>

        <li><strong>Identify several distinctive objects or landmarks</strong> along the way—these will be your loci.</li>

        <li><strong>Create vivid mental images that link new information to each locus</strong>, imagining these connections as you move through your route in order.</li>

        <li><strong>Make your images exaggerated, strange, or surprising</strong>, as unusual associations are typically much more memorable than ordinary ones.</li>
      </ol>

      <img src='Diagram2.png'style="width: 75%; display: block; margin: auto;"></img> 
      </div>

      <div style="text-align: center; margin-top: 100px;">
        <em>Press → to continue or ← to go back.</em>
      </div>
    </div>
  `
},


// Practice Example Page 1
{
stimulus: `
<div style="max-width: 800px; margin: auto; font-size: 18px; line-height: 1.8; text-align: left;">
      
    <div style="text-align: center; color: #3b80a9; font-size: 36px; font-weight: 600; margin-bottom: 20px;">
        Applying the Method of Loci:
      </div>

    <p>Let's practice using the Method of Loci!</p>

   <div style="color: #3b80a9; font-size: 22px; font-weight: 600; margin-bottom: 12px;">
      <strong>Practice Question #1</strong>
      </div>

    <p>How might you remember the word <strong>“telescope”</strong> if your route starts at the <strong>front door</strong> of your home?</p>

    <p><em>Take about 10 seconds now to create your own mental image.</em></p>
 <div style="text-align: center; margin-top: 100px;">
        <em>Press → to continue or ← to go back.</em>
      </div>
    </div>
`
},
// Practice Example Page 2
{
stimulus: `
<div style="max-width: 800px; margin: auto; font-size: 18px; line-height: 1.8; text-align: left;">

 <div style="color: #3b80a9; font-size: 22px; font-weight: 600; margin-bottom: 12px;">
      <strong>Example Association #1</strong>
      </div>

      <p>
        You might imagine approaching your front door, only to find a small telescope mounted 
        where the peephole should be. Curious, you lean in and look through it, expecting to see 
        inside your house, but instead, you see a tiny, animated solar system spinning behind 
        the door.
      </p>

      <p>
        This strange and unexpected image helps make the word <strong>“telescope”</strong> memorable, 
        while anchoring it to the first stop on your sequential memory route.
      </p>

      <p><em>
        Let’s try another example. This time, memorising a <strong>task</strong> that you intend to 
        complete later.
      </em></p>
      <div style="text-align: center; margin-top: 100px;">
        <em>Press → to continue or ← to go back.</em>
      </div>
    </div>
`
}, 

// Practice Example Page 3
{
stimulus: `
<div style="max-width: 800px; margin: auto; font-size: 18px; line-height: 1.8; text-align: left;">

 <div style="color: #3b80a9; font-size: 22px; font-weight: 600; margin-bottom: 12px;">
      <strong>Practice Question #2</strong>
      </div>

      <p>
        How might you create a memorable mental image to associate the task <strong>“reset router”</strong> 
        with a familiar object in your <strong>kitchen</strong>?
      </p>
    
      <p><em>
        Take about 10-20 seconds now to create your own mental image.    
      </em></p>

      <div style="text-align: center; margin-top: 100px;">
        <em>Press → to continue or ← to go back.</em>
      </div>
    </div>
`
}, 

// Practice Example Page 4
{
stimulus: `
    <div style="max-width: 800px; margin: auto; font-size: 18px; line-height: 1.8; text-align: left;">

      <div style="color: #3b80a9; font-size: 22px; font-weight: 600; margin-bottom: 12px;">
      <strong>Example Association #2</strong>
      </div>

      <p>
        You might picture yourself walking into your kitchen and noticing that your toaster has 
        suddenly transformed into a giant, glowing internet router.
      </p>

      <p>
        The toaster’s slots are flashing with colourful Wi-Fi symbol lights, and instead of toast popping out, it’s 
        shooting out glowing Wi-Fi signals.
      </p>

      <p>
        You reach out and push the toaster’s lever down, imagining that this 
        <strong>"resets"</strong> the router. This momentarily causes the toaster to shut down, before
        restarting, flashing even brighter lights, and shooting out larger Wi-Fi signals that swirl through the air.
      </p>

      <p><em>
        Notice how the image is not only tied to a familiar object—the toaster—but also includes a 
        distinctive and exaggerated action that represents the task itself. Making both the <strong>locus</strong> and 
        the <strong>action</strong> vivid and unusual helps strengthen recall.    
      </em></p>

      <div style="text-align: left; margin-top: 60px;">
        <em>Next, you will create and learn to utilise your own memory palace structure.</em>
      </div>

      <div style="text-align: center; margin-top: 100px;">
        <em>Press → to continue or ← to go back.</em>
      </div>
      
    </div>
  `
},

// Memory Palace Creation 1

{
stimulus: `
<div style="max-width: 800px; margin: auto; font-size: 18px; line-height: 1.8; text-align: left;">
      
    <div style="text-align: center; color: #3b80a9; font-size: 36px; font-weight: 600; margin-bottom: 20px;">
        <strong>Creating Your Loci Memory Route</strong>
      </div>

      <p> 
         In this part of the task, you will build a personalised memory structure using the Method 
        of Loci, before using it later to memorise a list of new information.
      </p>

      <div style="color: #3b80a9; font-size: 22px; font-weight: 600; margin-bottom: 12px;">
      <strong>Step 1: Choose a Familiar Setting</strong>
      </div>

      <!-- Bullet points with spacing -->
      <ul style="margin-left: 20px;">
        <li style="margin-bottom: 16px;">Think of a physical setting you know extremely well.</li>
        <li style="margin-bottom: 16px;">
          Choose somewhere you can easily visualise moving through in a set order, 
          noticing objects or landmarks along the way.
        </li>
        <li style="margin-bottom: 16px;">Take a moment to choose your setting now.</li>
      </ul>

      <div style="text-align: center; margin-top: 100px;">
        <em>Press → to continue or ← to go back.</em>
      </div>
      
    </div>
  `
},

// Memory Palace Creation 2

{
stimulus: `
<div style="max-width: 800px; margin: auto; font-size: 18px; line-height: 1.8; text-align: left;">
      
      <div style="color: #3b80a9; font-size: 22px; font-weight: 600; margin-bottom: 12px;">
      <strong>Step 2: Plan a Clear Route</strong>
      </div>

      <ul style="margin-left: 20px;">
        <li style="margin-bottom: 16px;">
          Imagine walking through this setting from a clear starting point 
          (for example, entering through the front door of your home).
        </li>

        <li style="margin-bottom: 16px;">
          Visualise moving step by step through the space, noticing around 15 distinctive objects or 
          locations along the way.

          <ul style="margin-left: 20px; list-style-type: circle;">
            <li>Example items could include a front door, hallway mirror, couch, fridge, desk, etc.</li>
          </ul>
        </li>

        <li style="margin-bottom: 16px;">Take approximately 2 minutes to do this now. Feel free to close
            your eyes if you prefer.</li>
      </ul>


      <div style="text-align: center; margin-top: 100px;">
        <em>Press → to continue or ← to go back.</em>
      </div>
      
    </div>
  `
  
}
];


const memoryLociForm = {
  type: jsPsychSurveyHtmlForm,
  preamble: `
    <div style="max-width: 800px; margin: auto; font-size: 18px; line-height: 1.8; text-align: left;">
      
      <div style="color: #3b80a9; font-size: 22px; font-weight: 600; margin-bottom: 12px;">
      <strong>Step 3: Write Down 15 Loci:</strong>
      </div>

      <p>Now that you've visualised your route, please write down the <strong>15 specific locations or objects</strong> (your loci) that you'll use to anchor new information.</p>
      <p>These should follow the order in which you would naturally move through the setting.</p>
      <p>Example: front door, hallway mirror, couch, coffee table, fridge...</p>
    </div>
  `,
  html: `
    ${[...Array(15)].map((_, i) =>
      `<p>${i + 1}. <input name="locus${i + 1}" type="text" style="width: 500px;" required></p>`
    ).join("")}
  `,
  button_label: "Save and Continue",
  on_finish: function(data) {
    jsPsych.data.addProperties({ memory_loci: data.response });
  }
};


const step4_rehearsal = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `
    <div style="max-width: 800px; margin: auto; font-size: 18px; line-height: 1.8; text-align: left;">
      
      <div style="color: #3b80a9; font-size: 22px; font-weight: 600; margin-bottom: 12px;">
      <strong>Step 4: Mentally Rehearse Your Route</strong>
      </div>
      
      <p>Close your eyes and mentally walk through your chosen route, step by step, identifying each of the 15 loci in order from memory.</p>
      <p style="text-align: center; margin-top: 40px;"><em>Press any key to continue.</em></p>
    </div>
  `
};


//Final task warning
const final_taskwarning = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `
<div style="max-width: 800px; margin: auto; font-size: 18px; line-height: 1.8; text-align: left;">
      
    <div style="text-align: center; color: #3b80a9; font-size: 36px; font-weight: 600; margin-bottom: 20px;">
    <strong>Practice Test</strong>
    </div>
<p>You will next be presented with 15 items to memorise, shown one at a time.</p>
      
      <p>You should use the loci memory structure you just created to help you remember items by mentally placing them sequentially along your route.</p>
      
    <p> This phase is solely intended for practice, so don't worry if it feels challenging, just give it your best go.</p>

      <ul style="margin-left: 20px; margin-top: 20px;">
        <li style="margin-bottom: 16px;">
          Eight of the items you'll see will be individual nouns (e.g., objects or things).
        </li>
        <li style="margin-bottom: 16px;">
          The other seven items will be everyday tasks, like the “reset router” example you saw earlier.
        </li>
      </ul>
      
      <p>Each noun will appear on the screen for 6.5 seconds, and each task will appear for 10 seconds.</p>
      
      <p>Once all items have been presented, you'll be directed to a page where you'll recall the list.</p>

      <p style="text-align: center; margin-top: 60px;">
        <em>Press any key to begin the task.</em>
      </p>
      
    </div>
  `
};


// ➤ Stimuli: 15 items
      const study_items = [
  "Compass",
  "Whistle",
  "Cactus",
  "Anchor",
  "Thermometer",
  "Salami",
  "Lantern",
  "Reaction",
  "Dust pantry",
  "Organise folders",
  "Defrost freezer",
  "Change batteries",
  "Descale kettle",
  "Replace medicine",
  "Hang Artwork"
];

// Split into nouns and tasks (first 8 are nouns, next 7 are tasks)
const noun_items = study_items.slice(0, 8);
const task_items = study_items.slice(8, 15);

// Interleave trials
const study_trials = [];

const max_pairs = Math.max(noun_items.length, task_items.length);

for (let i = 0; i < max_pairs; i++) {
  // If noun exists at this index, add it with 6.5s
  if (i < noun_items.length) {
    study_trials.push({
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <div style="display: flex; justify-content: center; align-items: center; height: 100vh;">
          <div style="font-size: 32px; color: black;">${noun_items[i]}</div>
        </div>
      `,
      choices: "NO_KEYS",
      trial_duration: 6500
    });

    // Red dot after noun if more items remain
    if (i < task_items.length || i < noun_items.length - 1) {
      study_trials.push({
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
          <div style="display: flex; justify-content: center; align-items: center; height: 100vh;">
            <div style="font-size: 48px; color: red;">•</div>
          </div>
        `,
        choices: "NO_KEYS",
        trial_duration: 500
      });
    }
  }

  // If task exists at this index, add it with 10s
  if (i < task_items.length) {
    study_trials.push({
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <div style="display: flex; justify-content: center; align-items: center; height: 100vh;">
          <div style="font-size: 32px; color: black;">${task_items[i]}</div>
        </div>
      `,
      choices: "NO_KEYS",
      trial_duration: 10000
    });

    // Red dot after task if more items remain
    if (i < noun_items.length - 1 || i < task_items.length - 1) {
      study_trials.push({
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
          <div style="display: flex; justify-content: center; align-items: center; height: 100vh;">
            <div style="font-size: 48px; color: red;">•</div>
          </div>
        `,
        choices: "NO_KEYS",
        trial_duration: 500
      });
    }
  }
}


  // Recall trial
  const recall_trial = {
    type: jsPsychSurveyHtmlForm,
    preamble: "<p>Please type the 15 items you remember from the previous task. Enter one item per box.</p>",
  html: `
    ${[...Array(15)].map((_, i) =>
      `<p>${i + 1}. <input name="item${i + 1}" type="text" style="width: 400px;" required></p>`
    ).join("")}
  `,
  button_label: "Submit"
};
 

const nice_work_warning = {
type: jsPsychHtmlKeyboardResponse,
stimulus: `
<div style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; text-align: left; font-size: 18px; line-height: 1.8; padding: 0 40px;">
      <div style="max-width: 800px;">
<p> <strong> Nice work! </strong> </p>
<p> Having now developed and practised using your visuo-spatial memory structure, 
    you’ll next put your new skills to the test.</p>

<div style="text-align: center; margin-top: 60px;">
          <p><em>Press any key to continue.</em></p>
        </div>
      </div>
    </div>
  `,
  };

  //Word Presentation Info Page 2
  const word_presentation_info_page2 = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `
    <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; text-align: left; font-size: 18px; line-height: 1.8; padding: 0 40px;">
      <div style="max-width: 800px;">

        <p>Just like you completed earler, in the upcoming task, you will see 15 words, shown one at a time, on your screen.</p>

        <p>Please read each word carefully and try to remember as many as you can. Each word will appear for 6.5 seconds before moving to the next one.</p>

        <p>Once all 15 words have been shown, you will complete a brief image comparison task, before being taken to a new screen where you will type in as many of the words as you can remember.</p>

        <p>You can list the words in any order. If you can’t remember all the words, don’t worry — just give your best guess.</p>

        <p style="margin-top: 40px;"><em>Press any key to begin the task.</em></p>

      </div>
    </div>
  `
};

// Define nouns
const test_nouns = ['Tablespoon', 'Woods', 'Joke', 'Candy', 'Home', 'Body', 'Nephew', 'Army', 'Geese',
 'Speech', 'Window', 'Market', 'Drama', 'City', 'Artist'];

// Store in data for later scoring
jsPsych.data.addProperties({ presented_test_nouns: test_nouns });

// Generate presentation trials
const Post_noun_trials = [];

test_nouns.forEach((word, index) => {
  Post_noun_trials.push({
    type: jsPsychHtmlKeyboardResponse,
    stimulus: `
      <div style="display: flex; justify-content: center; align-items: center; height: 100vh;">
        <div style="font-size: 32px; color: black;">${word}</div>
      </div>
    `,
    choices: "NO_KEYS",
    trial_duration:6500
  });

  if (index < test_nouns.length - 1) {
    Post_noun_trials.push({
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <div style="display: flex; justify-content: center; align-items: center; height: 100vh;">
          <div style="font-size: 48px; color: red;">•</div>
        </div>
      `,
      choices: "NO_KEYS",
      trial_duration: 500
    });
  }
});

// Recall page
const nouns_recall_post = {
  type: jsPsychSurveyHtmlForm,
  preamble: `
    <div style="max-width: 800px; margin: auto; font-size: 18px;">
      <p>Please type in as many of the 15 nouns you just saw as you can remember. You can list them in any order.</p>
      <p>For any nouns you can't remember, simply type N/a into the corresponding box/s.</p>
    </div>
  `,
  html: Array.from({ length: 15 }, (_, i) =>
    `<p> ${i + 1}: <input name="recall${i + 1}" type="text" style="width: 300px;" required></p>`
  ).join(''),
  button_label: "Submit",
  on_finish: function(data) {
    const responses = data.response;
    const nouns_post_correct = test_nouns.map(w => w.toLowerCase());
    let correctCount = 0;
    const incorrectWords = [];

    Object.values(responses).forEach(resp => {
      const cleaned = resp.trim().toLowerCase();
      if (cleaned !== 'n/a' && nouns_post_correct.includes(cleaned)) {
        correctCount++;
      } else {
        incorrectWords.push(cleaned);
      }
    });

    jsPsych.data.addProperties({
      nouns_post_correct: correctCount,
    });
  }
}

 //Task Presentation Info Page 2
const ToDo_presentation_info_page2 = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `
    <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; text-align: left; font-size: 18px; line-height: 1.8; padding: 0 40px;">
      <div style="max-width: 800px;">

        <p>Just like you completed earler, in the upcoming task, you will see 15 phrases, shown one at a time on your screen, describing a brief everyday task.</p>
         
        <p>Please read each item carefully and try to remember as many as you can. Each item will appear for 10 seconds before moving to the next one.</p>

        <p>Once all items have been shown, you will complete a brief image comparison task, before being taken to a new screen where you will type in as many of the items as you can remember.</p>

        <p>You can list the items in any order. If you can’t remember all the items, don’t worry — just give your best guess.</p>

        <p style="margin-top: 40px;"><em>Press any key to begin the task.</em></p>

      </div>
    </div>
  `
};


const download_data_screen = {
  type: jsPsychHtmlButtonResponse,
  stimulus: `
    <div style="text-align: center; font-size: 18px;">
      <p>Thank you for completing this pilot testing Session.</p>
      
      <p>Please download your performance data by clicking the button below.</p>

      <p>Once you've done this, you can close the tab.</p>
    </div>
  `,
  choices: ['Download Data'],
  on_finish: function() {
    jsPsych.data.get().localSave('csv', 'test_trial_data.csv');
  }
};

function generateMathDistractorPage(pageNumber, problemsArray) {
  return {
    type: jsPsychSurveyHtmlForm,
    preamble: `<div style="max-width: 800px; margin: auto; font-size: 18px;">
      <p><strong>Distractor Task Page ${pageNumber}</strong></p>
      <p>Solve as many of the following maths problems as you can in 60 seconds.</p>
      <p>After 60 seconds, this page will automatically move on.</p>
    </div>`,
    html: problemsArray.map((prob, i) =>
      `<p>${i + 1}. ${prob} = <input name="q${i + 1}" type="text" style="width: 60px;"></p>`
    ).join(""),
    button_label: "Submit",
    trial_duration: 60000, // 60 seconds
    on_load: function() {
      setTimeout(() => jsPsych.finishTrial(), 60000);
    },
    on_finish: function(data) {
      jsPsych.data.addProperties({ [`distractor_page_${pageNumber}`]: data.response });
    }
  };
}

const distractorProblems1 = [
  "3 + 4", "7 - 2", "9 + 6", "5 + 1", "8 - 3", "4 + 2", "6 - 1", "2 + 9", "1 + 5", "7 - 6",
  "10 + 3", "6 + 8", "12 - 7", "3 + 3", "14 - 6", "5 + 4", "8 + 5", "15 - 9", "2 + 6", "13 - 4",
  "1 + 1", "11 - 3", "7 + 2", "4 + 7", "9 - 5", "6 + 1", "10 - 8", "12 + 2", "3 + 8", "11 - 6"
];

const distractorProblems2 = ["6 + 7", "15 - 6", "4 + 9", "11 - 2", "2 + 5", "10 - 7", "9 + 3", "7 - 4", "6 + 4", "13 - 8",
  "8 + 2", "12 - 9", "1 + 3", "5 + 8", "10 - 3", "7 + 6", "14 - 5", "4 + 6", "3 + 2", "9 - 1",
  "8 - 2", "11 + 1", "13 - 7", "2 + 6", "5 + 7", "6 - 2", "12 + 3", "14 - 9", "1 + 6", "3 + 7"];

const distractorProblems3 = ["5 + 6", "11 - 4", "3 + 9", "14 - 8", "7 + 3", "6 - 5", "8 + 6", "2 + 7", "12 - 4", "10 + 2",
  "13 - 6", "9 + 4", "4 + 8", "11 - 7", "3 + 6", "7 + 5", "10 - 2", "1 + 2", "6 + 3", "5 - 1",
  "13 - 9", "8 + 7", "2 + 4", "9 - 3", "10 - 6", "1 + 4", "12 + 1", "7 - 5", "5 + 3", "6 + 2"];

const distractorProblems4 = ["9 + 2", "13 - 5", "3 + 5", "6 + 6", "8 - 1", "7 + 4", "14 - 7", "5 + 2", "11 - 6", "2 + 8",
  "12 - 5", "4 + 5", "1 + 7", "6 + 1", "3 + 4", "10 + 1", "9 - 4", "7 - 2", "13 - 3", "8 + 3",
  "12 - 6", "10 + 4", "2 + 3", "6 - 3", "5 + 1", "11 - 1", "9 + 1", "7 + 1", "4 + 6", "3 + 1"];

const distractorPage1 = generateMathDistractorPage(1, distractorProblems1);
const distractorPage2 = generateMathDistractorPage(2, distractorProblems2);
const distractorPage3 = generateMathDistractorPage(3, distractorProblems3);
const distractorPage4 = generateMathDistractorPage(4, distractorProblems4);


if (assignedGroup === 'TD/N') {
timeline.push(welcome_page);
timeline.push(ToDo_presentation_info_page1);
timeline.push(red_dot_start);
timeline.push(...generateTaskTrials(task_phase1_items, 'phase1'));
timeline.push(distractorPage1);
timeline.push(generateRecallPage(task_phase1_items, 'phase1'));
timeline.push(well_done_page);
timeline.push(word_presentation_info_page1);
timeline.push(red_dot_start);
timeline.push(...word_trials);
timeline.push(distractorPage2);
timeline.push(nouns_recall_pre);
timeline.push(instructionsLooping);
timeline.push(memoryLociForm);
timeline.push(step4_rehearsal);
timeline.push(final_taskwarning);
timeline.push(red_dot_start);
timeline.push(...study_trials);
timeline.push(recall_trial);
timeline.push(nice_work_warning);
timeline.push(ToDo_presentation_info_page2)
timeline.push(red_dot_start);
timeline.push(...generateTaskTrials(task_phase2_items, 'phase2'));
timeline.push(distractorPage3);
timeline.push(generateRecallPage(task_phase2_items, 'phase2'));
timeline.push(word_presentation_info_page2);
timeline.push(red_dot_start);
timeline.push(...Post_noun_trials);
timeline.push(distractorPage4);
timeline.push(nouns_recall_post);
timeline.push(download_data_screen);
};

if (assignedGroup === 'N/TD') {
timeline.push(welcome_page);
timeline.push(word_presentation_info_page1);
timeline.push(red_dot_start);
timeline.push(...word_trials);
timeline.push(distractorPage1);
timeline.push(nouns_recall_pre);
timeline.push(well_done_page);
timeline.push(ToDo_presentation_info_page1);
timeline.push(red_dot_start);
timeline.push(...generateTaskTrials(task_phase1_items, 'phase1'));
timeline.push(distractorPage2);
timeline.push(generateRecallPage(task_phase1_items, 'phase1'));
timeline.push(instructionsLooping);
timeline.push(memoryLociForm);
timeline.push(step4_rehearsal);
timeline.push(final_taskwarning);
timeline.push(red_dot_start);
timeline.push(...study_trials);
timeline.push(recall_trial);
timeline.push(nice_work_warning);
timeline.push(word_presentation_info_page2);
timeline.push(red_dot_start);
timeline.push(...Post_noun_trials);
timeline.push(distractorPage3);
timeline.push(nouns_recall_post);
timeline.push(ToDo_presentation_info_page2)
timeline.push(red_dot_start);
timeline.push(...generateTaskTrials(task_phase2_items, 'phase2'));
timeline.push(distractorPage4);
timeline.push(generateRecallPage(task_phase2_items, 'phase2'));
timeline.push(download_data_screen);
};




// Start the experiment
  jsPsych.run(timeline);

  </script>
</html>
